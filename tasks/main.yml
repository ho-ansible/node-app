---

- name: Node.js app | user
  tags:
    - user
  user:
    name: "{{ node_user }}"
    groups: "www-data"
    shell: /bin/false
    system: yes

- name: Node.js app | git clone
  tags:
    - package
    - git
  git:
    repo: "{{ node_repo }}"
    dest: "/home/{{ node_user }}/{{ node_name }}"
    depth: 1
  notify: restart node

- name: Node.js app | repo perms
  tags:
    - permissions
  file:
    path: "/home/{{ node_user }}/{{ node_name }}"
    owner: "{{ node_user }}"
    group: "{{ node_user }}"
    recurse: yes

- name: Node.js app | nginx host
  tags:
    - config
  template:
    src: node.nginx.j2
    dest: "/etc/nginx/sites-available/node-{{ node_name }}"
  notify: restart nginx

- name: Node.js app | enable nginx host
  tags:
    - config
  file:
    src: "/etc/nginx/sites-available/node-{{ node_name }}"
    dest: "/etc/nginx/sites-enabled/node-{{ node_name }}"
    state: link
  notify: restart nginx

- name: Node.js app | config dir
  tags:
    - dir
  file:
    path: "{{ node_config_dir }}"
    state: directory

- name: Node.js app | iptables
  tags:
    - iptables
  iptables:
    ip_version: "{{ item }}"
    chain: INPUT
    protocol: tcp
    destination_port: "{{ node_port }}"
    jump: ACCEPT
  loop: [ ipv4, ipv6 ]
  notify: iptables

- name: Node.js app | service config
  tags:
    - config
  template:
    src: node.conf.j2
    dest: "{{ node_config_dir }}/node.conf"
  notify: restart node

- name: Node.js app | systemd service
  tags:
    - systemd
  copy:
    src: "{{ item }}"
    dest: /lib/systemd/system/
  loop:
    - node.service
    - node@.service
  notify: restart node

- name: Node.js app | service
  tags:
    - service
  service:
    name: "{{ item }}"
    state: started
    enabled: true
  loop:
    - node
    - "node@{{ node_name }}"
